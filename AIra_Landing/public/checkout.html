<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - AIRA CRM</title>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png">
    <link rel="manifest" href="favicon_io/site.webmanifest">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000000;
            min-height: 100vh;
            overflow-x: hidden;
            color: white;
        }

        /* Neural Network Background Canvas */
        #neural-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            mix-blend-mode: screen;
        }

        /* Overlay gradients */
        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: radial-gradient(ellipse at top, transparent 0%, rgba(0, 0, 0, 0.7) 70%);
            pointer-events: none;
        }

        /* Stars */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }

        /* Grid pattern */
        .grid-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background-image:
                linear-gradient(rgba(16, 185, 129, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(16, 185, 129, 0.03) 1px, transparent 1px);
            background-size: 4rem 4rem;
            mask-image: radial-gradient(ellipse 80% 50% at 50% 0%, #000 70%, transparent 110%);
            pointer-events: none;
        }

        /* Container principal */
        .container {
            position: relative;
            z-index: 10;
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
        }

        .checkout-wrapper {
            width: 100%;
        }

        /* Header modernizado */
        .header {
            text-align: center;
            margin-bottom: 60px;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 10px 28px;
            border-radius: 16px;
            margin-bottom: 32px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            opacity: 0.7;
            font-weight: 300;
        }

        .logo-text {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #10b981, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(16, 185, 129, 0.5);
        }

        .logo-image {
            height: 50px;
            width: auto;
            filter: drop-shadow(0 0 20px rgba(16, 185, 129, 0.5));
        }

        h1 {
            font-size: 56px;
            font-weight: 900;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #10b981 0%, #34d399 50%, #6ee7b7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            text-shadow: 0 0 40px rgba(16, 185, 129, 0.3);
        }

        .subtitle {
            font-size: 22px;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 400;
        }

        /* Layout duas colunas */
        .checkout-grid {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 40px;
            align-items: start;
        }

        @media (max-width: 1024px) {
            .checkout-grid {
                grid-template-columns: 1fr;
                gap: 32px;
            }
            h1 {
                font-size: 42px;
            }
        }

        /* Card glassmorphism ultra moderno */
        .card {
            position: relative;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 32px;
            padding: 48px;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.4),
                inset 0 0 40px rgba(255, 255, 255, 0.02);
            transition: border-color 0.3s ease;
            animation: cardSlideIn 0.8s ease-out;
            min-height: auto;
            height: auto;
            overflow: visible;
        }

        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.1));
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            z-index: 0;
        }

        .card > * {
            position: relative;
            z-index: 1;
        }

        .card-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            gap: 16px;
            color: white;
        }

        .card-icon {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            opacity: 0.6;
            font-weight: 200;
        }

        /* Resumo do plano - neon style */
        .plan-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 24px;
            color: rgba(255, 255, 255, 0.75);
        }

        .plan-details {
            margin-bottom: 32px;
        }

        .plan-name {
            font-size: 40px;
            font-weight: 900;
            background: linear-gradient(135deg, #10b981, #34d399, #6ee7b7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            text-shadow: 0 0 40px rgba(16, 185, 129, 0.5);
        }

        .plan-price {
            font-size: 64px;
            font-weight: 900;
            margin-bottom: 8px;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
        }

        .plan-price span {
            font-size: 28px;
            color: rgba(255, 255, 255, 0.6);
        }

        .plan-period {
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
            font-weight: 500;
        }

        .features-list {
            list-style: none;
            margin-top: 32px;
        }

        .features-list li {
            padding: 16px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            gap: 16px;
            color: rgba(255, 255, 255, 0.95);
            font-size: 16px;
            transition: all 0.3s;
        }

        .features-list li:hover {
            padding-left: 8px;
            color: white;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 12px;
        }

        .features-list li:last-child {
            border-bottom: none;
        }

        .check-icon {
            width: 18px;
            height: 18px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 10px;
            opacity: 0.6;
        }

        /* Formulário moderno */
        .form-group {
            margin-bottom: 28px;
            position: relative;
            z-index: 10;
            overflow: visible;
            min-height: fit-content;
        }

        .form-label {
            display: block;
            margin-bottom: 12px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.95);
            font-size: 15px;
            letter-spacing: 0.3px;
            user-select: none;
            cursor: default;
        }

        .form-input {
            width: 100%;
            padding: 18px 20px;
            background: rgba(255, 255, 255, 0.04);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            position: relative;
            z-index: 10;
            cursor: text;
        }

        .form-input:hover {
            border-color: rgba(255, 255, 255, 0.2);
        }

        .form-input:focus {
            outline: none;
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.08);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
        }

        .form-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
            user-select: none;
        }

        /* Botão principal ultra moderno */
        .btn-primary {
            width: 100%;
            padding: 22px 40px;
            background: linear-gradient(135deg, #059669, #10b981, #34d399);
            background-size: 200% 200%;
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 20px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 10px 40px rgba(16, 185, 129, 0.4),
                0 0 60px rgba(5, 150, 105, 0.3);
            position: relative;
            overflow: hidden;
            animation: gradientShift 4s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .btn-primary:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow:
                0 20px 60px rgba(16, 185, 129, 0.6),
                0 0 80px rgba(5, 150, 105, 0.5);
        }

        .btn-primary:active {
            transform: translateY(-2px) scale(1.01);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        /* Loading spinner moderno */
        .spinner {
            display: inline-block;
            width: 22px;
            height: 22px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alertas modernos */
        .alert {
            padding: 20px 24px;
            border-radius: 16px;
            margin-bottom: 28px;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 15px;
            font-weight: 600;
            animation: alertSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        @keyframes alertSlideIn {
            from {
                opacity: 0;
                transform: translateY(-15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.15);
            border: 2px solid rgba(16, 185, 129, 0.4);
            color: #10b981;
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.2);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.2);
        }

        /* Segurança badge com neon */
        .security-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 28px;
            padding: 14px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
        }

        .security-icon {
            font-size: 16px;
            opacity: 0.5;
        }

        /* Payment Methods Info */
        .payment-methods-info {
            margin-top: 24px;
            margin-bottom: 24px;
            padding: 18px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 10;
        }

        .payment-methods-title {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 14px;
            text-align: center;
        }

        .payment-methods-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        @media (max-width: 600px) {
            .payment-methods-grid {
                grid-template-columns: 1fr;
            }
        }

        .payment-method-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 12px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            cursor: pointer;
            position: relative;
            z-index: 10;
            user-select: none;
        }

        .payment-method-item:hover:not(.active) {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .payment-method-item.active {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .payment-method-item.active::after {
            content: '✓';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 18px;
            height: 18px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
        }

        .payment-method-icon {
            font-size: 32px;
            opacity: 0.5;
            font-weight: 200;
        }

        .payment-method-name {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.85);
            text-align: center;
        }

        .payment-method-desc {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
        }

        /* Mercado Pago container */
        #mercadopago-container {
            margin-top: 28px;
            margin-bottom: 40px;
            padding: 0;
            position: relative;
            z-index: 10;
            transition: opacity 0.3s ease, min-height 0.3s ease;
            pointer-events: auto;
            overflow: visible;
            width: 100%;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        /* Forçar layout do formulário do MP em coluna única */
        #mercadopago-container > div,
        #mercadopago-container > form,
        #mercadopago-container [class*="container"],
        #mercadopago-container [class*="wrapper"],
        #mercadopago-container [class*="content"] {
            display: flex !important;
            flex-direction: column !important;
            width: 100% !important;
            max-width: 100% !important;
        }

        /* Garantir que imagens de bandeiras fiquem à esquerda */
        #mercadopago-container img,
        #mercadopago-container [class*="card-brand"],
        #mercadopago-container [class*="payment-method-icon"],
        #mercadopago-container [class*="brand-icon"] {
            display: inline-block !important;
            align-self: flex-start !important;
            margin-right: 8px !important;
            max-width: 48px !important;
            max-height: 32px !important;
            object-fit: contain !important;
        }

        /* Container de bandeiras de cartão */
        #mercadopago-container [class*="card-logos"],
        #mercadopago-container [class*="payment-methods"] {
            display: flex !important;
            flex-direction: row !important;
            gap: 8px !important;
            align-items: center !important;
            justify-content: flex-start !important;
            flex-wrap: wrap !important;
            margin: 8px 0 !important;
        }

        #mercadopago-container.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.6;
            min-height: 300px;
        }

        #mercadopago-container.loading::before {
            content: '';
            width: 50px;
            height: 50px;
            border: 4px solid rgba(16, 185, 129, 0.2);
            border-radius: 50%;
            border-top-color: #10b981;
            animation: spin 0.8s linear infinite;
        }

        #mercadopago-container > div,
        #mercadopago-container > form {
            animation: fadeIn 0.4s ease;
            width: 100%;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        #mercadopago-container button[type="submit"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
            height: 0;
            overflow: hidden;
        }

        /* Remover bordas de containers do MP */
        #mercadopago-container > div,
        #mercadopago-container > form,
        #mercadopago-container div[class*="container"],
        #mercadopago-container div[class*="wrapper"],
        #mercadopago-container div[class*="content"],
        #mercadopago-container div[class*="form"],
        #mercadopago-container fieldset {
            border: none !important;
            background: transparent !important;
            box-shadow: none !important;
            outline: none !important;
        }

        /* Customizar elementos do Mercado Pago */
        #mercadopago-container input {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 2px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 12px !important;
            color: white !important;
            padding: 16px !important;
            font-size: 15px !important;
            transition: border-color 0.3s ease, box-shadow 0.3s ease !important;
            position: relative !important;
            z-index: 100 !important;
            pointer-events: auto !important;
        }

        #mercadopago-container input:hover {
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        #mercadopago-container input:focus {
            border-color: #10b981 !important;
            background: rgba(16, 185, 129, 0.08) !important;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15) !important;
            outline: none !important;
        }

        #mercadopago-container select {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 2px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 12px !important;
            color: white !important;
            padding: 16px !important;
            font-size: 15px !important;
            position: relative !important;
            z-index: 100 !important;
            pointer-events: auto !important;
            cursor: pointer !important;
        }

        #mercadopago-container select:hover {
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        #mercadopago-container label {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 600 !important;
            font-size: 14px !important;
            margin-bottom: 8px !important;
            position: relative !important;
            z-index: 100 !important;
        }

        #mercadopago-container * {
            pointer-events: auto !important;
        }

        /* Garantir que nenhum div tenha borda */
        #mercadopago-container div:not([class*="input"]):not([class*="select"]) {
            border: none !important;
            outline: none !important;
        }

        /* Mostrar seletor de tipo de documento e estilizado */
        #mercadopago-container select[name*="identificationType"],
        #mercadopago-container select[name*="identification_type"],
        #mercadopago-container select[id*="form-checkout__identificationType"],
        #mercadopago-container [class*="identification-type"] select,
        #mercadopago-container [data-checkout*="docType"] {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 2px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 12px !important;
            color: white !important;
            padding: 16px !important;
            font-size: 15px !important;
            opacity: 1 !important;
            cursor: pointer !important;
            pointer-events: auto !important;
            appearance: menulist !important;
            -webkit-appearance: menulist !important;
            -moz-appearance: menulist !important;
            text-rendering: auto !important;
            letter-spacing: normal !important;
            word-spacing: normal !important;
            text-transform: none !important;
            text-indent: 0px !important;
            text-shadow: none !important;
            display: block !important;
            align-items: center !important;
            white-space: normal !important;
            line-height: 1.5 !important;
            width: 100% !important;
            max-width: 150px !important;
            min-width: 120px !important;
            font-family: inherit !important;
            font-weight: 500 !important;
        }

        /* Garantir que o texto do select seja visível */
        #mercadopago-container select[name*="identificationType"] option,
        #mercadopago-container select[name*="identification_type"] option,
        #mercadopago-container select[id*="form-checkout__identificationType"] option {
            color: white !important;
            background: #1a1a1a !important;
            padding: 12px !important;
            font-size: 15px !important;
            font-weight: 500 !important;
        }

        /* Forçar exibição do value selecionado */
        #mercadopago-container select[name*="identificationType"]:not([value=""]),
        #mercadopago-container select[name*="identification_type"]:not([value=""]) {
            font-weight: 600 !important;
        }

        /* Estilizar opções selecionadas do select */
        #mercadopago-container select[name*="identificationType"]:focus,
        #mercadopago-container select[name*="identification_type"]:focus,
        #mercadopago-container select[id*="form-checkout__identificationType"]:focus {
            border-color: #10b981 !important;
            background: rgba(16, 185, 129, 0.08) !important;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15) !important;
            outline: none !important;
        }

        /* Estilizar options do select */
        #mercadopago-container select option {
            background: #1a1a1a !important;
            color: white !important;
            padding: 12px !important;
        }

        /* Garantir que a opção selecionada seja visível */
        #mercadopago-container select option:checked,
        #mercadopago-container select option[selected] {
            background: #10b981 !important;
            color: white !important;
            font-weight: bold !important;
        }

        /* Garantir que o texto selecionado apareça no select fechado */
        #mercadopago-container select:not(:focus):not(:active) {
            color: white !important;
            text-overflow: ellipsis !important;
        }

        /* Estilizar label do tipo de documento */
        #mercadopago-container label[for*="identificationType"],
        #mercadopago-container label[for*="identification_type"],
        #mercadopago-container label[for*="form-checkout__identificationType"] {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 600 !important;
            font-size: 14px !important;
        }

        /* Ajustar container do campo de documento */
        #mercadopago-container [class*="identification"],
        #mercadopago-container [data-checkout*="doc"] {
            display: grid !important;
            grid-template-columns: 150px 1fr !important;
            gap: 12px !important;
            align-items: start !important;
        }

        /* Forçar todos os elementos filhos do MP a ficarem em coluna */
        #mercadopago-container > div > *,
        #mercadopago-container form > * {
            display: block !important;
            width: 100% !important;
            float: none !important;
            clear: both !important;
        }

        /* Evitar float nas imagens */
        #mercadopago-container img {
            float: none !important;
            position: relative !important;
        }

        /* Garantir que elementos em linha fiquem inline apenas dentro do próprio container */
        #mercadopago-container [class*="logos"],
        #mercadopago-container [class*="brands"],
        #mercadopago-container [class*="icons"] {
            display: inline-flex !important;
            flex-direction: row !important;
            gap: 8px !important;
            align-items: center !important;
        }

        /* Ajustar largura do campo de número do CPF */
        #mercadopago-container input[name*="identificationNumber"],
        #mercadopago-container input[name*="identification_number"],
        #mercadopago-container input[id*="form-checkout__identificationNumber"],
        #mercadopago-container [data-checkout*="docNumber"] {
            width: 100% !important;
            max-width: 100% !important;
        }

        /* Ajustar iframes e divs internos do MP */
        #mercadopago-container iframe,
        #mercadopago-container > div {
            width: 100% !important;
            max-width: 100% !important;
        }

        /* Card brand icons */
        #mercadopago-container .card-brand-icon {
            filter: brightness(1.2) !important;
        }

        /* PIX QR Code styling */
        #mercadopago-container img[alt*="qr"],
        #mercadopago-container canvas {
            border-radius: 12px !important;
            box-shadow: none !important;
            border: none !important;
            padding: 12px !important;
            background: white !important;
        }

        /* PIX code container */
        #mercadopago-container [class*="pix"] {
            background: transparent !important;
            border: none !important;
            border-radius: 0 !important;
            padding: 0 !important;
        }

        /* Ajustar QR Code do PIX */
        #mercadopago-container [class*="qr"] {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            flex-direction: column !important;
            gap: 16px !important;
        }

        /* Installments selector - GARANTIR VISIBILIDADE */
        #mercadopago-container select[name*="installment"],
        #mercadopago-container select[name*="parcela"],
        #mercadopago-container select[id*="installment"],
        #mercadopago-container [class*="installment"] select,
        #mercadopago-container [data-checkout*="installment"] {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 2px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 12px !important;
            color: white !important;
            padding: 16px !important;
            font-size: 15px !important;
            opacity: 1 !important;
            cursor: pointer !important;
            pointer-events: auto !important;
            display: block !important;
            visibility: visible !important;
            width: 100% !important;
            min-height: 56px !important;
            margin-top: 8px !important;
            margin-bottom: 8px !important;
        }

        /* Container do campo de parcelas */
        #mercadopago-container [class*="installment"],
        #mercadopago-container div[class*="installment"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            height: auto !important;
            min-height: fit-content !important;
            overflow: visible !important;
            margin-top: 16px !important;
            margin-bottom: 16px !important;
            padding: 0 !important;
        }

        /* Label do campo de parcelas */
        #mercadopago-container label[for*="installment"],
        #mercadopago-container [class*="installment"] label {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 600 !important;
            font-size: 14px !important;
            display: block !important;
            margin-bottom: 8px !important;
        }

        /* Formulários internos do MP */
        #mercadopago-container form {
            display: flex !important;
            flex-direction: column !important;
            gap: 16px !important;
            padding-bottom: 40px !important;
            min-height: 400px !important;
        }

        /* Garantir que todos os campos sejam visíveis */
        #mercadopago-container > div,
        #mercadopago-container > form,
        #mercadopago-container [class*="container"],
        #mercadopago-container [class*="wrapper"] {
            overflow: visible !important;
            min-height: fit-content !important;
        }

        /* Grid de campos do MP */
        #mercadopago-container [class*="row"],
        #mercadopago-container [class*="grid"] {
            display: grid !important;
            gap: 16px !important;
        }

        /* Error messages */
        #mercadopago-container [class*="error"],
        #mercadopago-container [class*="invalid"] {
            color: #ef4444 !important;
            font-size: 13px !important;
            margin-top: 4px !important;
        }

        /* Helper text */
        #mercadopago-container [class*="helper"],
        #mercadopago-container [class*="hint"] {
            color: rgba(255, 255, 255, 0.6) !important;
            font-size: 12px !important;
        }


        /* Back button moderno */
        .back-btn {
            position: fixed;
            top: 24px;
            left: 24px;
            z-index: 100;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(-4px);
        }

        /* Divider moderno */
        .divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.3), transparent);
            margin: 40px 0;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }

        /* Trust badges modernos */
        .trust-badges {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .trust-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            font-weight: 500;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            transition: all 0.3s;
        }

        .trust-badge:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px 16px;
            }

            .card {
                padding: 32px 24px;
            }

            h1 {
                font-size: 36px;
            }

            .plan-price {
                font-size: 48px;
            }

            .plan-name {
                font-size: 32px;
            }

            .checkout-grid {
                gap: 24px;
            }

            .back-btn {
                top: 16px;
                left: 16px;
                padding: 12px 20px;
            }

            #mercadopago-container {
                padding: 0;
                margin-top: 20px;
            }

            .payment-methods-info {
                padding: 12px;
                margin-top: 16px;
                margin-bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Neural Network Background -->
    <canvas id="neural-canvas"></canvas>

    <!-- Background overlays -->
    <div class="bg-overlay"></div>
    <div class="grid-pattern"></div>
    <div class="stars" id="stars-container"></div>

    <!-- Back button -->
    <a href="/" class="back-btn">
        <span>←</span>
        <span>Voltar</span>
    </a>

    <!-- Main container -->
    <div class="container">
        <div class="checkout-wrapper">
            <!-- Header -->
            <div class="header">
                <div class="logo">
                    <img src="AIra_Logotipo.png" alt="AIRA Logo" class="logo-image" />
                </div>
                <h1>Finalize sua Assinatura</h1>
                <p class="subtitle">Complete os dados para ativar seu CRM com IA</p>
            </div>

            <!-- Checkout grid -->
            <div class="checkout-grid">
                <!-- Coluna 1: Formulário de Pagamento -->
                <div class="card" style="animation-delay: 0.1s;">
                    <div class="card-title">
                        <div class="card-icon">□</div>
                        <span>Dados de Pagamento</span>
                    </div>

                    <!-- Alertas -->
                    <div id="alert-container"></div>

                    <!-- Formulário -->
                    <form id="payment-form">
                        <!-- Dados Pessoais -->
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input
                                type="email"
                                id="email"
                                class="form-input"
                                placeholder="seu@email.com"
                                required
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Nome Completo</label>
                            <input
                                type="text"
                                id="name"
                                class="form-input"
                                placeholder="João Silva"
                                required
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label">CPF</label>
                            <input
                                type="text"
                                id="cpf"
                                class="form-input"
                                placeholder="000.000.000-00"
                                maxlength="14"
                                required
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Telefone</label>
                            <input
                                type="tel"
                                id="phone"
                                class="form-input"
                                placeholder="(00) 00000-0000"
                                maxlength="15"
                                required
                            />
                        </div>

                        <div class="divider"></div>

                        <!-- Payment Methods Info -->
                        <div class="payment-methods-info">
                            <div class="payment-methods-title">Escolha o Meio de Pagamento</div>
                            <div class="payment-methods-grid">
                                <div class="payment-method-item active" data-method="credit_card" onclick="selectPaymentMethod('credit_card')">
                                    <div class="payment-method-icon">□</div>
                                    <div class="payment-method-name">Cartão de Crédito</div>
                                    <div class="payment-method-desc">Pagamento à vista</div>
                                </div>
                                <div class="payment-method-item" data-method="pix" onclick="selectPaymentMethod('pix')">
                                    <div class="payment-method-icon">◇</div>
                                    <div class="payment-method-name">PIX</div>
                                    <div class="payment-method-desc">Aprovação instantânea</div>
                                </div>
                            </div>
                        </div>

                        <!-- Mercado Pago Payment Brick -->
                        <div class="form-group">
                            <label class="form-label">Complete os dados de pagamento</label>
                            <div id="mercadopago-container" class="loading"></div>
                        </div>

                        <!-- Botão de Pagamento -->
                        <button type="submit" class="btn-primary" id="submit-btn">
                            <span id="btn-text">Confirmar Pagamento</span>
                        </button>
                    </form>
                </div>

                <!-- Coluna 2: Resumo do Plano -->
                <div class="card" style="animation-delay: 0.2s;">
                    <div class="card-title">
                        <div class="card-icon">◇</div>
                        <span>Resumo do Pedido</span>
                    </div>

                    <div class="plan-badge">
                        <span>·</span>
                        <span>Plano Selecionado</span>
                    </div>

                    <div class="plan-details">
                        <div class="plan-name" id="plan-name-display">Plano Profissional</div>
                        <div class="plan-price">
                            R$ <span id="plan-price-display">997</span>
                            <span>/mês</span>
                        </div>
                        <div class="plan-period" id="plan-description">Economize R$ 14.000/mês vs 3 CLTs</div>
                    </div>

                    <div class="divider"></div>

                    <ul class="features-list" id="plan-features">
                        <!-- Features serão inseridas aqui via JavaScript -->
                    </ul>

                    <div class="divider"></div>

                    <div class="security-badge">
                        <span class="security-icon">◉</span>
                        <span>Pagamento 100% seguro via Mercado Pago</span>
                    </div>

                    <div class="trust-badges">
                        <div class="trust-badge">
                            <span>·</span>
                            <span>SSL Seguro</span>
                        </div>
                        <div class="trust-badge">
                            <span>·</span>
                            <span>Criptografia</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mercado Pago SDK -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>

    <script>
        // ===================================
        // NEURAL NETWORK BACKGROUND
        // ===================================
        const canvas = document.getElementById('neural-canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        class Neuron {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.vx = (Math.random() - 0.5) * 0.5;
                this.vy = (Math.random() - 0.5) * 0.5;
                this.radius = 2;
                this.connections = [];
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;

                if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(16, 185, 129, 0.8)';
                ctx.shadowBlur = 10;
                ctx.shadowColor = 'rgba(16, 185, 129, 0.5)';
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        const neurons = Array(50).fill().map(() => new Neuron());

        function animate() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw connections
            for (let i = 0; i < neurons.length; i++) {
                for (let j = i + 1; j < neurons.length; j++) {
                    const dx = neurons[i].x - neurons[j].x;
                    const dy = neurons[i].y - neurons[j].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < 150) {
                        ctx.beginPath();
                        ctx.moveTo(neurons[i].x, neurons[i].y);
                        ctx.lineTo(neurons[j].x, neurons[j].y);
                        ctx.strokeStyle = `rgba(16, 185, 129, ${0.3 * (1 - distance / 150)})`;
                        ctx.lineWidth = 1;
                        ctx.stroke();
                    }
                }
            }

            // Update and draw neurons
            neurons.forEach(neuron => {
                neuron.update();
                neuron.draw();
            });

            requestAnimationFrame(animate);
        }

        animate();

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // ===================================
        // STARS
        // ===================================
        function createStars() {
            const starsContainer = document.getElementById('stars-container');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }
        createStars();

        // ===================================
        // DADOS DO PLANO
        // ===================================
        const urlParams = new URLSearchParams(window.location.search);
        const planId = parseInt(urlParams.get('plano') || '2');

        const plansData = {
            1: {
                name: 'Starter',
                price: 497,
                description: 'Economize R$ 4.500/mês vs 1 CLT',
                features: [
                    '1 Equipe de IA Completa',
                    'Até 1.000 conversas/mês',
                    'WhatsApp + Site + Redes Sociais',
                    'Trabalha 24/7 sem pausas',
                    'Nunca tira férias ou adoece',
                    'Conhecimento infinito atualizado',
                    'Suporte por Email'
                ]
            },
            2: {
                name: 'Professional',
                price: 997,
                description: 'Economize R$ 14.000/mês vs 3 CLTs',
                features: [
                    '3 Equipes de IA Completas',
                    'Conversas Ilimitadas',
                    'Todos os Canais Integrados',
                    'Analytics e BI Avançado',
                    'Zero encargos trabalhistas',
                    'Zero processos judiciais',
                    'Suporte Prioritário 24/7',
                    'Integrações Premium',
                    'API Completa'
                ]
            },
            3: {
                name: 'Enterprise',
                price: 1997,
                description: 'Substitua toda equipe de vendas',
                features: [
                    'Equipes de IA Ilimitadas',
                    'Tudo do Professional',
                    'White Label Completo',
                    'Gerente de Sucesso Dedicado',
                    'SLA Garantido 99.9%',
                    'Customizações Sob Medida',
                    'Treinamento Presencial',
                    'Infraestrutura Dedicada'
                ]
            }
        };

        const selectedPlan = plansData[planId];

        document.getElementById('plan-name-display').textContent = selectedPlan.name;
        document.getElementById('plan-price-display').textContent = selectedPlan.price;
        document.getElementById('plan-description').textContent = selectedPlan.description;

        const featuresList = document.getElementById('plan-features');
        selectedPlan.features.forEach(feature => {
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="check-icon">✓</div>
                <span>${feature}</span>
            `;
            featuresList.appendChild(li);
        });

        // ===================================
        // MÁSCARAS DE INPUT
        // ===================================
        document.getElementById('cpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);

            if (value.length > 9) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
            } else if (value.length > 3) {
                value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
            }

            e.target.value = value;
        });

        document.getElementById('phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);

            if (value.length > 10) {
                value = value.replace(/(\d{2})(\d{5})(\d{1,4})/, '($1) $2-$3');
            } else if (value.length > 6) {
                value = value.replace(/(\d{2})(\d{4})(\d{1,4})/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/(\d{2})(\d{1,5})/, '($1) $2');
            }

            e.target.value = value;
        });

        // ===================================
        // ALERTAS
        // ===================================
        function showAlert(message, type = 'error') {
            const alertContainer = document.getElementById('alert-container');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            const icon = type === 'success' ? '✓' : '⚠';

            alertContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    <span style="font-size: 20px;">${icon}</span>
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()" style="
                        margin-left: auto;
                        background: none;
                        border: none;
                        color: inherit;
                        cursor: pointer;
                        font-size: 24px;
                        padding: 0 8px;
                        opacity: 0.7;
                        transition: opacity 0.3s;
                    " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">×</button>
                </div>
            `;

            if (type === 'success') {
                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 5000);
            }
        }

        // ===================================
        // MERCADO PAGO INTEGRATION
        // ===================================
        let mp = null;
        let bricksBuilder = null;
        let paymentBrickController = null;
        let currentPaymentMethod = 'credit_card'; // Padrão: cartão de crédito
        let mpPublicKey = '';

        // Inicializar Mercado Pago
        async function initMercadoPago() {
            try {
                // Tentar buscar chave do backend
                const response = await fetch('http://localhost:5000/api/assinatura/test');
                const data = await response.json();

                if (data.public_key) {
                    mpPublicKey = data.public_key;
                } else {
                    // Fallback para chave de teste
                    mpPublicKey = 'TEST-c93f534c-1b3e-4f1c-b865-21af78c5e5ef';
                }
            } catch (error) {
                console.warn('[Checkout] Erro ao buscar chave do backend, usando chave de teste:', error);
                mpPublicKey = 'TEST-c93f534c-1b3e-4f1c-b865-21af78c5e5ef';
            }

            mp = new MercadoPago(mpPublicKey, {
                locale: 'pt-BR'
            });

            bricksBuilder = mp.bricks();

            // Inicializar com cartão de crédito
            await renderPaymentBrick('credit_card');
        }

        // Função para selecionar método de pagamento
        window.selectPaymentMethod = async function(method) {
            // Validar email antes de trocar para PIX
            if (method === 'pix') {
                const email = document.getElementById('email').value;
                if (!email || !validateEmail(email)) {
                    showAlert('Por favor, preencha um email válido antes de selecionar PIX');
                    // Destacar o campo de email
                    const emailInput = document.getElementById('email');
                    emailInput.focus();
                    emailInput.style.borderColor = '#ef4444';
                    setTimeout(() => {
                        emailInput.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                    }, 2000);
                    return;
                }
            }

            // Prevenir múltiplos cliques
            if (currentPaymentMethod === method) {
                return;
            }

            currentPaymentMethod = method;

            // Atualizar visual dos cards
            document.querySelectorAll('.payment-method-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-method="${method}"]`).classList.add('active');

            // Limpar alertas anteriores
            const alertContainer = document.getElementById('alert-container');
            if (alertContainer) {
                alertContainer.innerHTML = '';
            }

            // Re-renderizar brick com método específico
            await renderPaymentBrick(method);
        };

        // Validar email
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // Validar CPF
        function validateCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');

            if (cpf.length !== 11) return false;

            // Verificar se todos os dígitos são iguais
            if (/^(\d)\1{10}$/.test(cpf)) return false;

            // Validar primeiro dígito verificador
            let sum = 0;
            for (let i = 0; i < 9; i++) {
                sum += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let digit = 11 - (sum % 11);
            if (digit >= 10) digit = 0;
            if (digit !== parseInt(cpf.charAt(9))) return false;

            // Validar segundo dígito verificador
            sum = 0;
            for (let i = 0; i < 10; i++) {
                sum += parseInt(cpf.charAt(i)) * (11 - i);
            }
            digit = 11 - (sum % 11);
            if (digit >= 10) digit = 0;
            if (digit !== parseInt(cpf.charAt(10))) return false;

            return true;
        }

        // Adicionar feedback visual aos campos
        function addFieldValidation() {
            const emailInput = document.getElementById('email');
            const cpfInput = document.getElementById('cpf');
            const phoneInput = document.getElementById('phone');
            const nameInput = document.getElementById('name');

            emailInput.addEventListener('blur', function() {
                if (this.value && !validateEmail(this.value)) {
                    this.style.borderColor = '#ef4444';
                } else if (this.value) {
                    this.style.borderColor = '#10b981';
                } else {
                    this.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                }
            });

            cpfInput.addEventListener('blur', function() {
                const cpf = this.value.replace(/\D/g, '');
                if (cpf && !validateCPF(cpf)) {
                    this.style.borderColor = '#ef4444';
                } else if (cpf) {
                    this.style.borderColor = '#10b981';
                } else {
                    this.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                }
            });

            phoneInput.addEventListener('blur', function() {
                const phone = this.value.replace(/\D/g, '');
                if (phone && phone.length < 10) {
                    this.style.borderColor = '#ef4444';
                } else if (phone) {
                    this.style.borderColor = '#10b981';
                } else {
                    this.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                }
            });

            nameInput.addEventListener('blur', function() {
                if (this.value && this.value.trim().split(' ').length < 2) {
                    this.style.borderColor = '#ef4444';
                } else if (this.value) {
                    this.style.borderColor = '#10b981';
                } else {
                    this.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                }
            });

            // Limpar borda ao focar
            [emailInput, cpfInput, phoneInput, nameInput].forEach(input => {
                input.addEventListener('focus', function() {
                    this.style.borderColor = '#10b981';
                });
            });
        }

        // Função de atualização automática removida - não necessária com cardPayment Brick
        function setupAutoUpdateBrick() {
            // Não faz nada - mantida apenas para compatibilidade
        }

        // Chamar validação após carregamento
        setTimeout(() => {
            addFieldValidation();
            setupAutoUpdateBrick();
        }, 500);

        const renderPaymentBrick = async (paymentMethod = 'credit_card') => {
            const container = document.getElementById('mercadopago-container');

            if (!bricksBuilder) {
                showAlert('Sistema de pagamento não inicializado. Aguarde...');
                return;
            }

            try {
                // Mostrar loading
                container.classList.add('loading');
                container.innerHTML = '';

                // Destruir brick anterior se existir
                if (paymentBrickController) {
                    try {
                        await paymentBrickController.unmount();
                    } catch (e) {
                        console.log('[Mercado Pago] Erro ao destruir brick:', e);
                    }
                    paymentBrickController = null;
                }

                // Pegar dados do formulário se disponíveis
                const emailInput = document.getElementById('email');
                const nameInput = document.getElementById('name');
                const cpfInput = document.getElementById('cpf');

                const userEmail = emailInput && emailInput.value ? emailInput.value : '';
                const userName = nameInput && nameInput.value ? nameInput.value.trim() : '';
                const userCpf = cpfInput && cpfInput.value ? cpfInput.value.replace(/\D/g, '') : '';

                // Separar nome
                const nameParts = userName.split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || nameParts[0] || '';

                console.log('[DEBUG] Método de pagamento:', paymentMethod);
                console.log('[DEBUG] Email:', userEmail);
                console.log('[DEBUG] Nome:', firstName, lastName);

                // ====================================
                // CARTÃO DE CRÉDITO - Formulário Customizado
                // ====================================
                if (paymentMethod === 'credit_card') {
                    container.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 20px; padding: 0;">

                            <!-- Botão de Teste MercadoPago -->
                            <button
                                id="btn-fill-test-card"
                                type="button"
                                style="
                                    background: linear-gradient(135deg, #10b981, #059669);
                                    border: none;
                                    border-radius: 12px;
                                    color: white;
                                    padding: 12px 20px;
                                    font-size: 14px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                "
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'"
                            >
                                <span>🧪</span>
                                <span>Preencher com Cartão de Teste</span>
                            </button>

                            <!-- Número do Cartão -->
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; font-size: 14px;">
                                    Número do Cartão
                                </label>
                                <input
                                    type="text"
                                    id="card-number"
                                    placeholder="0000 0000 0000 0000"
                                    maxlength="19"
                                    style="
                                        background: rgba(255, 255, 255, 0.05);
                                        border: 2px solid rgba(255, 255, 255, 0.1);
                                        border-radius: 12px;
                                        color: white;
                                        padding: 16px;
                                        font-size: 15px;
                                        width: 100%;
                                        outline: none;
                                        transition: all 0.3s ease;
                                    "
                                />
                                <div id="card-brand" style="display: flex; gap: 8px; margin-top: 4px;">
                                    <!-- Logos das bandeiras serão inseridas aqui -->
                                </div>
                            </div>

                            <!-- Nome no Cartão -->
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; font-size: 14px;">
                                    Nome no Cartão
                                </label>
                                <input
                                    type="text"
                                    id="card-holder-name"
                                    placeholder="Nome como está no cartão"
                                    style="
                                        background: rgba(255, 255, 255, 0.05);
                                        border: 2px solid rgba(255, 255, 255, 0.1);
                                        border-radius: 12px;
                                        color: white;
                                        padding: 16px;
                                        font-size: 15px;
                                        width: 100%;
                                        outline: none;
                                        text-transform: uppercase;
                                    "
                                />
                            </div>

                            <!-- Validade e CVV -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; font-size: 14px;">
                                        Validade
                                    </label>
                                    <input
                                        type="text"
                                        id="card-expiry"
                                        placeholder="MM/AA"
                                        maxlength="5"
                                        style="
                                            background: rgba(255, 255, 255, 0.05);
                                            border: 2px solid rgba(255, 255, 255, 0.1);
                                            border-radius: 12px;
                                            color: white;
                                            padding: 16px;
                                            font-size: 15px;
                                            width: 100%;
                                            outline: none;
                                        "
                                    />
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; font-size: 14px;">
                                        CVV
                                    </label>
                                    <input
                                        type="text"
                                        id="card-cvv"
                                        placeholder="123"
                                        maxlength="4"
                                        style="
                                            background: rgba(255, 255, 255, 0.05);
                                            border: 2px solid rgba(255, 255, 255, 0.1);
                                            border-radius: 12px;
                                            color: white;
                                            padding: 16px;
                                            font-size: 15px;
                                            width: 100%;
                                            outline: none;
                                        "
                                    />
                                </div>
                            </div>

                            <!-- CPF/CNPJ -->
                            <div style="display: grid; grid-template-columns: 150px 1fr; gap: 12px;">
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; font-size: 14px;">
                                        Tipo
                                    </label>
                                    <select
                                        id="card-doc-type"
                                        style="
                                            background: rgba(255, 255, 255, 0.05);
                                            border: 2px solid rgba(255, 255, 255, 0.1);
                                            border-radius: 12px;
                                            color: white;
                                            padding: 16px;
                                            font-size: 15px;
                                            width: 100%;
                                            outline: none;
                                            cursor: pointer;
                                        "
                                    >
                                        <option value="CPF" selected>CPF</option>
                                        <option value="CNPJ">CNPJ</option>
                                    </select>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; font-size: 14px;">
                                        Número do Documento
                                    </label>
                                    <input
                                        type="text"
                                        id="card-doc-number"
                                        placeholder="000.000.000-00"
                                        value="${userCpf || ''}"
                                        style="
                                            background: rgba(255, 255, 255, 0.05);
                                            border: 2px solid rgba(255, 255, 255, 0.1);
                                            border-radius: 12px;
                                            color: white;
                                            padding: 16px;
                                            font-size: 15px;
                                            width: 100%;
                                            outline: none;
                                        "
                                    />
                                </div>
                            </div>

                            <div style="
                                padding: 12px 16px;
                                background: rgba(16, 185, 129, 0.1);
                                border: 1px solid rgba(16, 185, 129, 0.3);
                                border-radius: 12px;
                                color: rgba(255, 255, 255, 0.8);
                                font-size: 13px;
                                text-align: center;
                            ">
                                💳 Pagamento seguro processado pelo Mercado Pago
                            </div>
                        </div>
                    `;

                    container.classList.remove('loading');

                    // Adicionar event listeners para formatação
                    const cardNumberInput = document.getElementById('card-number');
                    const cardExpiryInput = document.getElementById('card-expiry');
                    const cardCvvInput = document.getElementById('card-cvv');
                    const cardDocNumber = document.getElementById('card-doc-number');

                    // Formatação do número do cartão
                    cardNumberInput.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\s/g, '');
                        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                        e.target.value = formattedValue;

                        // Detectar bandeira
                        detectCardBrand(value);

                        // Focus automático
                        if (value.length === 16) {
                            document.getElementById('card-holder-name').focus();
                        }
                    });

                    // Formatação da validade
                    cardExpiryInput.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        if (value.length >= 2) {
                            value = value.slice(0, 2) + '/' + value.slice(2, 4);
                        }
                        e.target.value = value;

                        if (value.length === 5) {
                            cardCvvInput.focus();
                        }
                    });

                    // Somente números no CVV
                    cardCvvInput.addEventListener('input', function(e) {
                        e.target.value = e.target.value.replace(/\D/g, '');
                    });

                    // Formatação CPF/CNPJ
                    cardDocNumber.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        const docType = document.getElementById('card-doc-type').value;

                        if (docType === 'CPF') {
                            if (value.length <= 11) {
                                value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                            }
                        } else {
                            if (value.length <= 14) {
                                value = value.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                            }
                        }
                        e.target.value = value;
                    });

                    // Trocar formato ao mudar tipo de documento
                    document.getElementById('card-doc-type').addEventListener('change', function(e) {
                        const input = document.getElementById('card-doc-number');
                        input.value = '';
                        input.placeholder = e.target.value === 'CPF' ? '000.000.000-00' : '00.000.000/0000-00';
                    });

                    // Adicionar estilo de focus
                    [cardNumberInput, document.getElementById('card-holder-name'), cardExpiryInput, cardCvvInput, cardDocNumber].forEach(input => {
                        input.addEventListener('focus', function() {
                            this.style.borderColor = '#10b981';
                            this.style.boxShadow = '0 0 0 4px rgba(16, 185, 129, 0.15)';
                        });
                        input.addEventListener('blur', function() {
                            this.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                            this.style.boxShadow = 'none';
                        });
                    });

                    // Botão de Preencher com Dados de Teste MercadoPago
                    const btnFillTest = document.getElementById('btn-fill-test-card');
                    if (btnFillTest) {
                        btnFillTest.addEventListener('click', function() {
                            console.log('[Checkout] Preenchendo com cartão de teste MercadoPago');

                            // Preencher com dados de cartão de teste Mastercard aprovado
                            cardNumberInput.value = '5031 4332 1540 6351';
                            document.getElementById('card-holder-name').value = 'APRO VENDEAI';
                            cardExpiryInput.value = '11/25';
                            cardCvvInput.value = '123';
                            document.getElementById('card-doc-type').value = 'CPF';
                            cardDocNumber.value = '123.456.789-00';

                            // Trigger de detecção de bandeira
                            const brandContainer = document.getElementById('card-brand');
                            brandContainer.innerHTML = `
                                <span style="
                                    padding: 6px 12px;
                                    background: rgba(255, 193, 7, 0.1);
                                    border: 1px solid rgba(255, 193, 7, 0.3);
                                    border-radius: 8px;
                                    color: #FFC107;
                                    font-size: 12px;
                                    font-weight: 600;
                                ">
                                    Mastercard
                                </span>
                            `;

                            // Feedback visual
                            btnFillTest.innerHTML = `<span>✅</span><span>Dados de Teste Preenchidos!</span>`;
                            btnFillTest.style.background = 'linear-gradient(135deg, #059669, #047857)';

                            setTimeout(() => {
                                btnFillTest.innerHTML = `<span>🧪</span><span>Preencher com Cartão de Teste</span>`;
                                btnFillTest.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                            }, 2000);
                        });
                    }

                    // Função para detectar bandeira do cartão
                    function detectCardBrand(cardNumber) {
                        const brandContainer = document.getElementById('card-brand');
                        const firstDigits = cardNumber.substring(0, 6);

                        let brand = 'unknown';
                        if (/^4/.test(firstDigits)) brand = 'visa';
                        else if (/^5[1-5]/.test(firstDigits)) brand = 'mastercard';
                        else if (/^3[47]/.test(firstDigits)) brand = 'amex';
                        else if (/^6(?:011|5)/.test(firstDigits)) brand = 'discover';
                        else if (/^35/.test(firstDigits)) brand = 'jcb';
                        else if (/^(5018|5020|5038|6304|6759|676[1-3])/.test(firstDigits)) brand = 'maestro';
                        else if (/^(606282|3841)/.test(firstDigits)) brand = 'hipercard';
                        else if (/^636368/.test(firstDigits)) brand = 'elo';

                        if (brand !== 'unknown' && cardNumber.length >= 6) {
                            brandContainer.innerHTML = `
                                <span style="
                                    padding: 6px 12px;
                                    background: rgba(16, 185, 129, 0.2);
                                    border: 1px solid rgba(16, 185, 129, 0.4);
                                    border-radius: 8px;
                                    color: #10b981;
                                    font-size: 12px;
                                    font-weight: 600;
                                    text-transform: uppercase;
                                ">
                                    ${brand}
                                </span>
                            `;
                        } else {
                            brandContainer.innerHTML = '';
                        }

                        window.currentCardBrand = brand;
                    }

                    console.log('[Checkout] Formulário de cartão customizado criado');
                }
                // ====================================
                // PIX - Usar payment Brick
                // ====================================
                else if (paymentMethod === 'pix') {
                    const payerConfig = {
                        email: userEmail || '',
                        entityType: 'individual'
                    };

                    if (firstName && lastName) {
                        payerConfig.firstName = firstName;
                        payerConfig.lastName = lastName;
                    }

                    if (userCpf && userCpf.length >= 11) {
                        payerConfig.identification = {
                            type: userCpf.length === 11 ? 'CPF' : 'CNPJ',
                            number: userCpf
                        };
                    }

                    const pixSettings = {
                        initialization: {
                            amount: selectedPlan.price,
                            payer: payerConfig
                        },
                        customization: {
                            paymentMethods: {
                                creditCard: false,
                                debitCard: false,
                                bankTransfer: ['pix']
                            },
                            visual: {
                                style: {
                                    theme: 'dark',
                                    customVariables: {
                                        baseColor: '#10b981',
                                        textPrimaryColor: '#ffffff',
                                        textSecondaryColor: '#9ca3af',
                                        inputBackgroundColor: 'rgba(255, 255, 255, 0.05)',
                                        formBackgroundColor: 'transparent'
                                    }
                                },
                                hideFormTitle: true
                            }
                        },
                        callbacks: {
                            onReady: () => {
                                console.log('[Mercado Pago] ✅ PIX Brick carregado');
                                container.classList.remove('loading');
                            },
                            onSubmit: async (pixFormData) => {
                                console.log('[DEBUG] PIX form data:', pixFormData);
                                return handlePayment(pixFormData);
                            },
                            onError: (error) => {
                                console.error('[Mercado Pago] ❌ Erro PIX:', error);
                                showAlert('Erro ao gerar PIX. Tente novamente.');
                                container.classList.remove('loading');
                            }
                        }
                    };

                    paymentBrickController = await bricksBuilder.create('payment', 'mercadopago-container', pixSettings);
                    console.log('[Mercado Pago] ✅ PIX Payment Brick criado com sucesso');
                }

            } catch (error) {
                console.error('[Mercado Pago] Erro ao renderizar brick:', error);
                container.classList.remove('loading');
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: rgba(255, 255, 255, 0.7);">
                        <p>Erro ao carregar formulário de pagamento.</p>
                        <p style="font-size: 14px; margin-top: 10px;">Tente recarregar a página.</p>
                    </div>
                `;
                showAlert('Erro ao carregar formulário de pagamento. Tente novamente.');
            }
        };

        // Função de debug para listar elementos do Mercado Pago
        function debugMercadoPagoElements() {
            const container = document.getElementById('mercadopago-container');
            console.log('[DEBUG] === Elementos do Mercado Pago ===');

            // Listar todos os inputs
            const inputs = container.querySelectorAll('input');
            console.log('[DEBUG] Total de inputs:', inputs.length);
            inputs.forEach((input, idx) => {
                console.log(`[DEBUG] Input ${idx}:`, {
                    name: input.name,
                    id: input.id,
                    type: input.type,
                    placeholder: input.placeholder,
                    visible: input.offsetHeight > 0,
                    display: window.getComputedStyle(input).display,
                    visibility: window.getComputedStyle(input).visibility
                });
            });

            // Listar todos os selects
            const selects = container.querySelectorAll('select');
            console.log('[DEBUG] Total de selects:', selects.length);
            selects.forEach((select, idx) => {
                console.log(`[DEBUG] Select ${idx}:`, {
                    name: select.name,
                    id: select.id,
                    options: select.options.length,
                    value: select.value,
                    visible: select.offsetHeight > 0,
                    display: window.getComputedStyle(select).display,
                    visibility: window.getComputedStyle(select).visibility
                });
            });

            // Listar iframes
            const iframes = container.querySelectorAll('iframe');
            console.log('[DEBUG] Total de iframes:', iframes.length);
            iframes.forEach((iframe, idx) => {
                console.log(`[DEBUG] Iframe ${idx}:`, {
                    src: iframe.src,
                    width: iframe.offsetWidth,
                    height: iframe.offsetHeight,
                    visible: iframe.offsetHeight > 0
                });
            });

            // Listar divs principais
            const divs = container.querySelectorAll('div[class], div[id]');
            console.log('[DEBUG] Total de divs com class/id:', divs.length);
            divs.forEach((div, idx) => {
                if (div.offsetHeight > 0) {
                    console.log(`[DEBUG] Div ${idx}:`, {
                        class: div.className,
                        id: div.id,
                        width: div.offsetWidth,
                        height: div.offsetHeight,
                        display: window.getComputedStyle(div).display,
                        overflow: window.getComputedStyle(div).overflow
                    });
                }
            });

            // Verificar especificamente campo de parcelas
            const installmentSelectors = [
                'select[name*="installment"]',
                'select[name*="parcela"]',
                'select[id*="installment"]',
                '[class*="installment"] select',
                '[data-checkout*="installment"]'
            ];

            let installmentFound = false;
            for (const selector of installmentSelectors) {
                const element = container.querySelector(selector);
                if (element) {
                    installmentFound = true;
                    console.log('[DEBUG] ✅ Campo de parcelas encontrado:', {
                        selector: selector,
                        name: element.name,
                        id: element.id,
                        visible: element.offsetHeight > 0,
                        display: window.getComputedStyle(element).display,
                        parentVisible: element.parentElement.offsetHeight > 0
                    });
                    break;
                }
            }

            if (!installmentFound) {
                console.warn('[DEBUG] ❌ Campo de parcelas NÃO encontrado!');
            }

            console.log('[DEBUG] === Fim Debug ===');
        }

        // Funções de parcelas removidas - não necessárias com cardPayment Brick

        // Inicializar Mercado Pago quando a página carregar
        initMercadoPago();

        // ===================================
        // PROCESSAR PAGAMENTO
        // ===================================
        async function handlePayment(formData) {
            const submitBtn = document.getElementById('submit-btn');
            const btnText = document.getElementById('btn-text');

            submitBtn.disabled = true;
            btnText.innerHTML = '<span class="spinner"></span> Processando...';

            try {
                const email = document.getElementById('email').value.trim();
                const name = document.getElementById('name').value.trim();
                const cpf = document.getElementById('cpf').value.replace(/\D/g, '');
                const phone = document.getElementById('phone').value.replace(/\D/g, '');

                // Validações detalhadas
                if (!email || !name || !cpf || !phone) {
                    throw new Error('Por favor, preencha todos os campos obrigatórios');
                }

                if (!validateEmail(email)) {
                    throw new Error('Email inválido. Verifique o formato do email');
                }

                if (name.split(' ').length < 2) {
                    throw new Error('Por favor, informe seu nome completo');
                }

                if (!validateCPF(cpf)) {
                    throw new Error('CPF inválido. Verifique os números digitados');
                }

                if (phone.length < 10 || phone.length > 11) {
                    throw new Error('Telefone inválido. Digite um número válido');
                }

                const brickData = formData.formData || formData;
                const paymentMethodId = brickData.payment_method_id;

                console.log('[Checkout] === DADOS DO PAGAMENTO ===');
                console.log('[Checkout] Método selecionado:', currentPaymentMethod);
                console.log('[Checkout] Payment method ID:', paymentMethodId);
                console.log('[Checkout] Brick data completo:', JSON.stringify(brickData, null, 2));

                // Verificar se é PIX baseado no método selecionado
                const isPix = currentPaymentMethod === 'pix' || paymentMethodId === 'pix';
                const isDebit = currentPaymentMethod === 'debit_card' ||
                               (paymentMethodId && (paymentMethodId.includes('deb') ||
                                                   brickData.payment_type_id === 'debit_card'));

                console.log('[Checkout] É PIX?', isPix);
                console.log('[Checkout] É Débito?', isDebit);

                // Validar dados obrigatórios do brick
                if (!isPix && !brickData.token) {
                    throw new Error('Token de pagamento não gerado. Verifique os dados do cartão.');
                }

                if (!paymentMethodId) {
                    throw new Error('Método de pagamento não identificado. Tente novamente.');
                }

                const paymentPayload = {
                    plano_id: planId,
                    usuario_email: email,
                    payment_method_id: paymentMethodId,
                    payment_type_id: isPix ? 'bank_transfer' : (isDebit ? 'debit_card' : 'credit_card'),
                    installments: isPix ? 1 : (parseInt(brickData.installments) || 1),
                    payer: {
                        email: email,
                        first_name: name.split(' ')[0],
                        last_name: name.split(' ').slice(1).join(' ') || name.split(' ')[0],
                        identification: {
                            type: 'CPF',
                            number: cpf
                        }
                    }
                };

                // Adicionar token apenas se não for PIX
                if (!isPix && brickData.token) {
                    paymentPayload.token = brickData.token;
                }

                // Adicionar issuer_id se disponível (cartão de crédito)
                if (!isPix && brickData.issuer_id) {
                    paymentPayload.issuer_id = brickData.issuer_id;
                }

                // Adicionar transaction_amount para PIX
                if (isPix) {
                    paymentPayload.transaction_amount = selectedPlan.price;
                    paymentPayload.description = `Assinatura ${selectedPlan.name} - AIra CRM`;
                    console.log('[Checkout] Pagamento via PIX detectado');
                } else {
                    // Para cartão, adicionar amount e descrição
                    paymentPayload.transaction_amount = selectedPlan.price;
                    paymentPayload.description = `Assinatura ${selectedPlan.name} - AIra CRM`;
                }

                // Log do payload final
                console.log('[Checkout] Payload final:', JSON.stringify(paymentPayload, null, 2));

                const response = await fetch('http://localhost:5000/api/assinatura/processar-pagamento', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(paymentPayload)
                });

                if (!response.ok) {
                    let errorMessage = 'Erro ao processar pagamento';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || errorMessage;
                        console.error('[Checkout] Erro do servidor:', errorData);
                    } catch (e) {
                        console.error('[Checkout] Erro ao parsear resposta de erro');
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('[Checkout] Resposta do servidor:', result);

                // PIX precisa de tratamento especial
                if (isPix && result.success) {
                    if (result.status === 'pending') {
                        // PIX gerado com sucesso, aguardando pagamento
                        showAlert('PIX gerado! Escaneie o QR Code ou copie o código abaixo.', 'success');

                        console.log('[Checkout] PIX QR Code:', result.qr_code);
                        console.log('[Checkout] PIX QR Code Base64:', result.qr_code_base64);
                        console.log('[Checkout] PIX aguardando pagamento...');

                        // Mostrar QR Code e código PIX na tela
                        const mpContainer = document.getElementById('mercadopago-container');
                        mpContainer.innerHTML = `
                            <div style="
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                gap: 24px;
                                padding: 32px;
                                background: rgba(255, 255, 255, 0.02);
                                border: 2px solid rgba(16, 185, 129, 0.3);
                                border-radius: 20px;
                                margin-top: 20px;
                            ">
                                <div style="
                                    font-size: 20px;
                                    font-weight: 700;
                                    color: #10b981;
                                    text-align: center;
                                ">
                                    ✅ PIX Gerado com Sucesso!
                                </div>

                                <div style="
                                    padding: 16px;
                                    background: white;
                                    border-radius: 16px;
                                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                                ">
                                    <img
                                        src="data:image/png;base64,${result.qr_code_base64}"
                                        alt="QR Code PIX"
                                        style="
                                            width: 280px;
                                            height: 280px;
                                            display: block;
                                        "
                                    />
                                </div>

                                <div style="
                                    text-align: center;
                                    color: rgba(255, 255, 255, 0.9);
                                    font-size: 15px;
                                    max-width: 400px;
                                ">
                                    <p style="margin-bottom: 16px;">Abra o app do seu banco e escaneie o QR Code acima ou copie o código PIX abaixo:</p>
                                </div>

                                <div style="
                                    width: 100%;
                                    max-width: 500px;
                                    position: relative;
                                ">
                                    <input
                                        type="text"
                                        id="pix-code-input"
                                        value="${result.qr_code}"
                                        readonly
                                        style="
                                            width: 100%;
                                            padding: 16px 120px 16px 16px;
                                            background: rgba(255, 255, 255, 0.05);
                                            border: 2px solid rgba(255, 255, 255, 0.1);
                                            border-radius: 12px;
                                            color: white;
                                            font-family: 'Courier New', monospace;
                                            font-size: 13px;
                                            word-break: break-all;
                                            white-space: nowrap;
                                            overflow: hidden;
                                            text-overflow: ellipsis;
                                        "
                                    />
                                    <button
                                        onclick="
                                            const input = document.getElementById('pix-code-input');
                                            input.select();
                                            document.execCommand('copy');
                                            this.textContent = '✓ Copiado!';
                                            this.style.background = '#10b981';
                                            setTimeout(() => {
                                                this.textContent = 'Copiar Código';
                                                this.style.background = 'linear-gradient(135deg, #059669, #10b981)';
                                            }, 2000);
                                        "
                                        style="
                                            position: absolute;
                                            right: 8px;
                                            top: 50%;
                                            transform: translateY(-50%);
                                            padding: 10px 20px;
                                            background: linear-gradient(135deg, #059669, #10b981);
                                            border: none;
                                            border-radius: 8px;
                                            color: white;
                                            font-weight: 600;
                                            font-size: 13px;
                                            cursor: pointer;
                                            transition: all 0.3s;
                                        "
                                    >
                                        Copiar Código
                                    </button>
                                </div>

                                <div style="
                                    padding: 16px 24px;
                                    background: rgba(16, 185, 129, 0.1);
                                    border: 1px solid rgba(16, 185, 129, 0.3);
                                    border-radius: 12px;
                                    text-align: center;
                                    color: rgba(255, 255, 255, 0.8);
                                    font-size: 13px;
                                ">
                                    ⏱️ Aguardando confirmação do pagamento...
                                    <br/>
                                    <span style="font-size: 12px; opacity: 0.7;">O sistema detectará automaticamente quando você pagar</span>
                                </div>
                            </div>
                        `;

                        // Reabilitar botão
                        submitBtn.disabled = false;
                        btnText.textContent = 'Voltar e escolher outro método';

                        // Polling para verificar status do pagamento a cada 5 segundos
                        const pollInterval = setInterval(async () => {
                            try {
                                const statusResponse = await fetch(`http://localhost:5000/api/assinatura/verificar-pagamento/${result.payment_id}`);
                                const statusData = await statusResponse.json();

                                if (statusData.status === 'approved') {
                                    clearInterval(pollInterval);
                                    showAlert('Pagamento PIX aprovado! Redirecionando...', 'success');
                                    const token = statusData.token_definir_senha || '';
                                    setTimeout(() => {
                                        window.location.href = `http://localhost:5177?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}&from=payment`;
                                    }, 2000);
                                }
                            } catch (error) {
                                console.error('[Checkout] Erro ao verificar status:', error);
                            }
                        }, 5000);

                        // Parar polling após 15 minutos
                        setTimeout(() => {
                            clearInterval(pollInterval);
                            console.log('[Checkout] Polling encerrado após 15 minutos');
                        }, 15 * 60 * 1000);

                        return;
                    } else if (result.status === 'approved') {
                        showAlert('Pagamento PIX aprovado! Redirecionando...', 'success');
                        const token = result.token_definir_senha || '';
                        setTimeout(() => {
                            window.location.href = `http://localhost:5177?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}&from=payment`;
                        }, 2000);
                    }
                } else if (result.success && result.status === 'approved') {
                    // Cartão de crédito/débito aprovado
                    showAlert('Pagamento aprovado! Redirecionando...', 'success');

                    const token = result.token_definir_senha || '';

                    setTimeout(() => {
                        window.location.href = `http://localhost:5177?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}&from=payment`;
                    }, 2000);
                } else {
                    throw new Error(result.error || result.message || 'Erro ao processar pagamento');
                }
            } catch (error) {
                console.error('[Checkout] Erro:', error);

                // Mostrar mensagem de erro mais amigável
                let errorMessage = 'Erro ao processar pagamento. Tente novamente.';
                if (error.message) {
                    errorMessage = error.message;
                }

                showAlert(errorMessage);

                // Restaurar botão
                submitBtn.disabled = false;
                btnText.textContent = 'Confirmar Pagamento';

                // Scroll para o topo para mostrar o erro
                window.scrollTo({ top: 0, behavior: 'smooth' });

                return { error: error.message };
            }
        }

        // ===================================
        // VALIDAÇÃO E ENVIO DO FORMULÁRIO
        // ===================================
        document.getElementById('payment-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const name = document.getElementById('name').value;
            const cpf = document.getElementById('cpf').value.replace(/\D/g, '');
            const phone = document.getElementById('phone').value.replace(/\D/g, '');

            if (!email || !name || !cpf || !phone) {
                showAlert('Preencha todos os campos obrigatórios');
                return;
            }

            if (cpf.length !== 11) {
                showAlert('CPF inválido');
                return;
            }

            if (phone.length < 10) {
                showAlert('Telefone inválido');
                return;
            }

            // Se for formulário customizado de cartão
            if (currentPaymentMethod === 'credit_card') {
                await processCustomCardForm(email, name, cpf, phone);
            }
            // Se for PIX, clicar no botão do Brick
            else {
                const mpSubmitButton = document.querySelector('#mercadopago-container button[type="submit"]');
                if (mpSubmitButton) {
                    mpSubmitButton.click();
                } else {
                    showAlert('Sistema de pagamento ainda não carregado. Aguarde um momento.');
                }
            }
        });

        // Processar formulário de cartão customizado
        async function processCustomCardForm(email, name, cpf, phone) {
            const submitBtn = document.getElementById('submit-btn');
            const btnText = document.getElementById('btn-text');

            submitBtn.disabled = true;
            btnText.innerHTML = '<span class="spinner"></span> Processando...';

            try {
                // Validar campos do cartão
                const cardNumber = document.getElementById('card-number')?.value.replace(/\s/g, '');
                const cardHolderName = document.getElementById('card-holder-name')?.value;
                const cardExpiry = document.getElementById('card-expiry')?.value;
                const cardCvv = document.getElementById('card-cvv')?.value;
                const cardDocType = document.getElementById('card-doc-type')?.value;
                const cardDocNumber = document.getElementById('card-doc-number')?.value.replace(/\D/g, '');

                if (!cardNumber || !cardHolderName || !cardExpiry || !cardCvv || !cardDocNumber) {
                    throw new Error('Preencha todos os dados do cartão');
                }

                if (cardNumber.length < 13 || cardNumber.length > 19) {
                    throw new Error('Número do cartão inválido');
                }

                if (cardExpiry.length !== 5) {
                    throw new Error('Data de validade inválida');
                }

                if (cardCvv.length < 3) {
                    throw new Error('CVV inválido');
                }

                // Separar mês e ano
                const [expMonth, expYear] = cardExpiry.split('/');

                // Obter payment method e issuer usando o BIN do cartão
                console.log('[Checkout] Obtendo informações do cartão via BIN...');
                const bin = cardNumber.replace(/\s/g, '').substring(0, 6);

                let paymentMethodId = 'visa'; // padrão
                let issuerId = null;

                try {
                    // Detectar payment method baseado no primeiro dígito
                    if (cardNumber.startsWith('4')) {
                        paymentMethodId = 'visa';
                    } else if (cardNumber.startsWith('5')) {
                        paymentMethodId = 'master';
                    } else if (cardNumber.startsWith('3')) {
                        paymentMethodId = 'amex';
                    } else if (cardNumber.startsWith('6')) {
                        paymentMethodId = 'elo';
                    }

                    console.log('[Checkout] Payment method detectado:', paymentMethodId);
                    console.log('[Checkout] BIN do cartão:', bin);

                    // Buscar issuers disponíveis para este payment method e BIN
                    const issuersResponse = await mp.getIssuers({
                        paymentMethodId: paymentMethodId,
                        bin: bin
                    });

                    console.log('[Checkout] Issuers encontrados:', issuersResponse);

                    if (issuersResponse && issuersResponse.length > 0) {
                        issuerId = issuersResponse[0].id;
                        console.log('[Checkout] Issuer ID selecionado:', issuerId);
                    } else {
                        console.warn('[Checkout] Nenhum issuer encontrado, continuando sem issuer_id');
                    }

                } catch (error) {
                    console.warn('[Checkout] Erro ao buscar issuer:', error);
                    console.log('[Checkout] Continuando sem issuer_id - Mercado Pago vai detectar automaticamente');
                }

                // Criar token do cartão usando Mercado Pago SDK
                console.log('[Checkout] Criando token do cartão...');

                const cardToken = await mp.createCardToken({
                    cardNumber: cardNumber,
                    cardholderName: cardHolderName,
                    cardExpirationMonth: expMonth,
                    cardExpirationYear: '20' + expYear,
                    securityCode: cardCvv,
                    identificationType: cardDocType,
                    identificationNumber: cardDocNumber
                });

                console.log('[Checkout] Token criado:', cardToken.id);

                // Criar payload para enviar ao backend
                const paymentPayload = {
                    plano_id: planId,
                    usuario_email: email,
                    payment_method_id: paymentMethodId,
                    payment_type_id: 'credit_card',
                    token: cardToken.id,
                    installments: 1,
                    transaction_amount: selectedPlan.price,
                    description: `Assinatura ${selectedPlan.name} - AIra CRM`,
                    payer: {
                        email: email,
                        first_name: name.split(' ')[0],
                        last_name: name.split(' ').slice(1).join(' ') || name.split(' ')[0],
                        identification: {
                            type: cardDocType,
                            number: cardDocNumber
                        }
                    }
                };

                // Adicionar issuer_id se encontrado
                if (issuerId) {
                    paymentPayload.issuer_id = String(issuerId);
                    console.log('[Checkout] Issuer ID incluído no payload:', issuerId);
                } else {
                    console.log('[Checkout] Sem issuer_id - Mercado Pago detectará automaticamente');
                }

                console.log('[Checkout] Payload completo:', JSON.stringify(paymentPayload, null, 2));

                const response = await fetch('http://localhost:5000/api/assinatura/processar-pagamento', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(paymentPayload)
                });

                if (!response.ok) {
                    let errorMessage = 'Erro ao processar pagamento';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || errorMessage;
                        console.error('[Checkout] Erro do servidor:', errorData);
                    } catch (e) {
                        console.error('[Checkout] Erro ao parsear resposta de erro');
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('[Checkout] Resposta COMPLETA do servidor:', result);
                console.log('[Checkout] Status recebido:', result.status);
                console.log('[Checkout] Status detail:', result.status_detail);

                // Handle all possible Mercado Pago statuses
                if (result.success) {
                    switch(result.status) {
                        case 'approved':
                            showAlert('✅ Pagamento aprovado! Redirecionando...', 'success');
                            const token = result.token_definir_senha || '';
                            setTimeout(() => {
                                window.location.href = `http://localhost:5177?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}&from=payment`;
                            }, 2000);
                            break;

                        case 'pending':
                        case 'in_process':
                            const pendingMessages = {
                                'pending_contingency': 'Pagamento em análise. Aguarde a confirmação.',
                                'pending_review_manual': 'Pagamento sendo revisado manualmente.',
                                'pending_waiting_payment': 'Aguardando pagamento.',
                                'pending_waiting_transfer': 'Aguardando transferência bancária.',
                                'in_process': 'Pagamento sendo processado.'
                            };
                            const pendingMsg = pendingMessages[result.status_detail] || 'Pagamento pendente.';
                            showAlert(`⏳ ${pendingMsg} Você receberá um email de confirmação.`, 'info');
                            console.log('[Checkout] Pagamento pendente - Status detail:', result.status_detail);

                            // Opcionalmente redirecionar para página de pending
                            setTimeout(() => {
                                showAlert('Verifique seu email para acompanhar o status do pagamento.', 'info');
                            }, 3000);
                            break;

                        case 'rejected':
                            const rejectMessages = {
                                'cc_rejected_bad_filled_card_number': 'Número do cartão incorreto.',
                                'cc_rejected_bad_filled_date': 'Data de validade incorreta.',
                                'cc_rejected_bad_filled_other': 'Verifique os dados do cartão.',
                                'cc_rejected_bad_filled_security_code': 'Código de segurança incorreto.',
                                'cc_rejected_blacklist': 'Cartão não autorizado.',
                                'cc_rejected_call_for_authorize': 'Entre em contato com o banco emissor.',
                                'cc_rejected_card_disabled': 'Cartão desabilitado.',
                                'cc_rejected_duplicated_payment': 'Pagamento duplicado.',
                                'cc_rejected_high_risk': 'Pagamento rejeitado por risco.',
                                'cc_rejected_insufficient_amount': 'Saldo insuficiente.',
                                'cc_rejected_invalid_installments': 'Número de parcelas inválido.',
                                'cc_rejected_max_attempts': 'Limite de tentativas excedido.'
                            };
                            const rejectMsg = rejectMessages[result.status_detail] || result.status_detail || 'Motivo não especificado';
                            showAlert(`❌ Pagamento rejeitado. Motivo: ${rejectMsg}`, 'error');
                            console.error('[Checkout] Pagamento rejeitado:', result.status_detail);
                            break;

                        case 'cancelled':
                            showAlert('⚠️ Pagamento cancelado.', 'warning');
                            break;

                        case 'refunded':
                            showAlert('↩️ Pagamento estornado.', 'info');
                            break;

                        default:
                            showAlert(`Status: ${result.status}. Verifique seu email para mais informações.`, 'info');
                            console.log('[Checkout] Status não mapeado:', result.status, result.status_detail);
                    }
                } else {
                    throw new Error(result.error || result.message || 'Erro ao processar pagamento');
                }

            } catch (error) {
                console.error('[Checkout] Erro:', error);
                showAlert(error.message || 'Erro ao processar pagamento. Tente novamente.');
            } finally {
                submitBtn.disabled = false;
                btnText.textContent = 'Confirmar Pagamento';
            }
        }
    </script>
</body>
</html>
