{% extends "base.html" %}

{% block title %}Dashboard - RoboVendedor{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
            <p class="text-muted">Vis√£o geral do sistema de prospec√ß√£o</p>
        </div>
        <div>
            <button id="btnConectarRobo" class="btn btn-lg btn-primary">
                <i class="bi bi-whatsapp"></i> Conectar Rob√¥ WhatsApp
            </button>
            <span id="statusConexao" class="badge bg-secondary ms-2" style="display: none;">
                <i class="bi bi-circle-fill"></i> Verificando...
            </span>
        </div>
    </div>
</div>

<!-- Cards de Estat√≠sticas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1">Total de Lojas</h6>
                        <h2 class="mb-0">{{ stats.total_lojas }}</h2>
                    </div>
                    <i class="bi bi-building stat-icon"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stat-card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1">Com WhatsApp</h6>
                        <h2 class="mb-0">{{ stats.com_whatsapp }}</h2>
                        <small>{{ "%.1f"|format(stats.percentual_whatsapp) }}%</small>
                    </div>
                    <i class="bi bi-whatsapp stat-icon"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stat-card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1">Mensagens Enviadas</h6>
                        <h2 class="mb-0">{{ stats.total_mensagens_enviadas }}</h2>
                    </div>
                    <i class="bi bi-send stat-icon"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stat-card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1">Taxa de Resposta</h6>
                        <h2 class="mb-0">{{ "%.1f"|format(stats.taxa_resposta) }}%</h2>
                        <small>{{ stats.total_respostas }} respostas</small>
                    </div>
                    <i class="bi bi-chat-dots stat-icon"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Card de Disparos -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-send"></i> Disparos de Mensagens</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-grid gap-2">
                            <button id="btnDisparoTeste" class="btn btn-outline-primary btn-lg">
                                <i class="bi bi-test-tube"></i> Disparo de Teste
                            </button>
                            <small class="text-muted text-center">
                                Envia mensagem para +55 67 9988-3484
                            </small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-grid gap-2">
                            <button id="btnDisparoMassa" class="btn btn-success btn-lg">
                                <i class="bi bi-broadcast"></i> Disparo em Massa
                            </button>
                            <small class="text-muted text-center">
                                Envia mensagens para todas as lojas pendentes
                            </small>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info mt-3 mb-0" role="alert">
                    <i class="bi bi-info-circle"></i>
                    <strong>Importante:</strong> Certifique-se de que o WhatsApp est√° conectado antes de iniciar os disparos.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gr√°ficos -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-bar-chart"></i> Status de Prospec√ß√£o</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-geo-alt"></i> Top 10 Cidades</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="cidadesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabela de Status -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-list-check"></i> Detalhamento por Status</h5>
            </div>
            <div class="card-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Quantidade</th>
                            <th>Porcentagem</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for status, count in stats.por_status.items() %}
                        <tr>
                            <td>
                                {% if status == 'pendente' %}
                                    <span class="badge badge-status bg-warning">‚è≥ Pendente</span>
                                {% elif status == 'enviado' %}
                                    <span class="badge badge-status bg-info">üì§ Enviado</span>
                                {% elif status == 'respondeu' %}
                                    <span class="badge badge-status bg-success">üí¨ Respondeu</span>
                                {% elif status == 'agendou_demo' %}
                                    <span class="badge badge-status bg-purple">üìÖ Agendou Demo</span>
                                {% elif status == 'converteu' %}
                                    <span class="badge badge-status bg-success">‚úÖ Converteu</span>
                                {% elif status == 'rejeitou' %}
                                    <span class="badge badge-status bg-danger">‚ùå Rejeitou</span>
                                {% elif status == 'optout' %}
                                    <span class="badge badge-status bg-secondary">üö´ Opt-out</span>
                                {% endif %}
                            </td>
                            <td><strong>{{ count }}</strong></td>
                            <td>
                                {% if stats.total_lojas > 0 %}
                                    {{ "%.1f"|format((count / stats.total_lojas) * 100) }}%
                                {% else %}
                                    0%
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('lojas') }}?status={{ status }}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i> Ver
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal QR Code WhatsApp -->
<div class="modal fade" id="modalQRCode" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-whatsapp"></i> Conectar WhatsApp
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrCodeContainer">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p>Aguarde, gerando QR Code...</p>
                </div>
                <div id="qrCodeInstructions" style="display: none;">
                    <h6 class="mb-3">Escaneie este QR Code com seu WhatsApp:</h6>
                    <div id="qrCodeImage" class="mb-3"></div>
                    <div class="alert alert-info">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            Abra o WhatsApp no celular > Menu > Aparelhos conectados > Conectar um aparelho
                        </small>
                    </div>
                </div>
                <div id="qrCodeConnected" style="display: none;">
                    <div class="text-success mb-3">
                        <i class="bi bi-check-circle" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="text-success">WhatsApp Conectado!</h5>
                    <p class="text-muted">O rob√¥ est√° pronto para enviar mensagens.</p>
                </div>
                <div id="qrCodeError" style="display: none;" class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    <span id="errorMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Controle do bot√£o de conex√£o WhatsApp
let modalQRCode = null;
let intervalStatus = null;

document.addEventListener('DOMContentLoaded', function() {
    modalQRCode = new bootstrap.Modal(document.getElementById('modalQRCode'));

    // Verificar status inicial
    verificarStatusConexao();

    // Verificar a cada 5 segundos
    intervalStatus = setInterval(verificarStatusConexao, 5000);

    // Bot√£o conectar
    document.getElementById('btnConectarRobo').addEventListener('click', function() {
        iniciarConexao();
    });

    // Bot√£o disparo de teste
    document.getElementById('btnDisparoTeste').addEventListener('click', function() {
        executarDisparoTeste();
    });

    // Bot√£o disparo em massa
    document.getElementById('btnDisparoMassa').addEventListener('click', function() {
        executarDisparoMassa();
    });
});

// Verificar status da conex√£o
function verificarStatusConexao() {
    fetch('/api/whatsapp/status')
        .then(response => response.json())
        .then(data => {
            const statusBadge = document.getElementById('statusConexao');
            const btnConectar = document.getElementById('btnConectarRobo');

            statusBadge.style.display = 'inline-block';

            if (data.connected) {
                statusBadge.className = 'badge bg-success ms-2';
                statusBadge.innerHTML = '<i class="bi bi-circle-fill"></i> Conectado';
                btnConectar.innerHTML = '<i class="bi bi-whatsapp"></i> WhatsApp Conectado';
                btnConectar.className = 'btn btn-lg btn-success';
            } else {
                statusBadge.className = 'badge bg-danger ms-2';
                statusBadge.innerHTML = '<i class="bi bi-circle-fill"></i> Desconectado';
                btnConectar.innerHTML = '<i class="bi bi-whatsapp"></i> Conectar Rob√¥ WhatsApp';
                btnConectar.className = 'btn btn-lg btn-primary';
            }
        })
        .catch(error => {
            console.error('Erro ao verificar status:', error);
        });
}

// Iniciar conex√£o
function iniciarConexao() {
    modalQRCode.show();

    // Reset modal
    document.getElementById('qrCodeContainer').style.display = 'block';
    document.getElementById('qrCodeInstructions').style.display = 'none';
    document.getElementById('qrCodeConnected').style.display = 'none';
    document.getElementById('qrCodeError').style.display = 'none';

    // Solicitar conex√£o
    fetch('/api/whatsapp/connect', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Aguardar QR Code
                aguardarQRCode();
            } else {
                mostrarErro(data.error || 'Erro ao iniciar conex√£o');
            }
        })
        .catch(error => {
            mostrarErro('Erro ao conectar: ' + error.message);
        });
}

// Aguardar QR Code
function aguardarQRCode() {
    const checkQR = setInterval(() => {
        fetch('/api/whatsapp/qrcode')
            .then(response => response.json())
            .then(data => {
                if (data.qrCode) {
                    // Mostrar QR Code
                    document.getElementById('qrCodeContainer').style.display = 'none';
                    document.getElementById('qrCodeInstructions').style.display = 'block';
                    document.getElementById('qrCodeImage').innerHTML = `<img src="${data.qrCode}" style="max-width: 300px;" />`;

                    clearInterval(checkQR);
                    aguardarConexao();

                } else if (data.connected) {
                    // J√° conectado
                    mostrarConectado();
                    clearInterval(checkQR);
                }
            })
            .catch(error => {
                console.error('Erro ao buscar QR:', error);
            });
    }, 2000);

    // Timeout de 60 segundos
    setTimeout(() => {
        clearInterval(checkQR);
    }, 60000);
}

// Aguardar confirma√ß√£o de conex√£o
function aguardarConexao() {
    const checkConnection = setInterval(() => {
        fetch('/api/whatsapp/status')
            .then(response => response.json())
            .then(data => {
                if (data.connected) {
                    mostrarConectado();
                    clearInterval(checkConnection);
                }
            })
            .catch(error => {
                console.error('Erro ao verificar conex√£o:', error);
            });
    }, 2000);

    // Timeout de 2 minutos
    setTimeout(() => {
        clearInterval(checkConnection);
    }, 120000);
}

// Mostrar conectado
function mostrarConectado() {
    document.getElementById('qrCodeContainer').style.display = 'none';
    document.getElementById('qrCodeInstructions').style.display = 'none';
    document.getElementById('qrCodeConnected').style.display = 'block';

    verificarStatusConexao();

    setTimeout(() => {
        modalQRCode.hide();
    }, 3000);
}

// Mostrar erro
function mostrarErro(mensagem) {
    document.getElementById('qrCodeContainer').style.display = 'none';
    document.getElementById('qrCodeInstructions').style.display = 'none';
    document.getElementById('qrCodeError').style.display = 'block';
    document.getElementById('errorMessage').textContent = mensagem;
}

// Executar disparo de teste
function executarDisparoTeste() {
    const btn = document.getElementById('btnDisparoTeste');

    if (!confirm('Deseja enviar uma mensagem de teste para +55 67 9988-3484?')) {
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enviando...';

    fetch('/api/disparo/teste', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Mensagem de teste enviada com sucesso!');
                btn.className = 'btn btn-success btn-lg';
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Teste Enviado!';

                setTimeout(() => {
                    btn.className = 'btn btn-outline-primary btn-lg';
                    btn.innerHTML = '<i class="bi bi-test-tube"></i> Disparo de Teste';
                    btn.disabled = false;
                }, 3000);
            } else {
                alert('Erro ao enviar teste: ' + (data.error || 'Erro desconhecido'));
                btn.className = 'btn btn-outline-primary btn-lg';
                btn.innerHTML = '<i class="bi bi-test-tube"></i> Disparo de Teste';
                btn.disabled = false;
            }
        })
        .catch(error => {
            alert('Erro ao enviar teste: ' + error.message);
            btn.className = 'btn btn-outline-primary btn-lg';
            btn.innerHTML = '<i class="bi bi-test-tube"></i> Disparo de Teste';
            btn.disabled = false;
        });
}

// Executar disparo em massa
function executarDisparoMassa() {
    const btn = document.getElementById('btnDisparoMassa');

    if (!confirm('ATEN√á√ÉO! Isso vai enviar mensagens para TODAS as lojas pendentes. Deseja continuar?')) {
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processando...';

    fetch('/api/disparo/massa', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Disparo em massa iniciado!\n\nTotal a enviar: ${data.total}\n\nO processo est√° rodando em background.`);
                btn.className = 'btn btn-success btn-lg';
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Disparo Iniciado!';

                setTimeout(() => {
                    btn.className = 'btn btn-success btn-lg';
                    btn.innerHTML = '<i class="bi bi-broadcast"></i> Disparo em Massa';
                    btn.disabled = false;
                    location.reload(); // Recarregar para atualizar estat√≠sticas
                }, 3000);
            } else {
                alert('Erro ao iniciar disparo em massa: ' + (data.error || 'Erro desconhecido'));
                btn.className = 'btn btn-success btn-lg';
                btn.innerHTML = '<i class="bi bi-broadcast"></i> Disparo em Massa';
                btn.disabled = false;
            }
        })
        .catch(error => {
            alert('Erro ao iniciar disparo: ' + error.message);
            btn.className = 'btn btn-success btn-lg';
            btn.innerHTML = '<i class="bi bi-broadcast"></i> Disparo em Massa';
            btn.disabled = false;
        });
}

// Gr√°fico de Status
fetch('/api/charts/status')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('statusChart');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.data,
                    backgroundColor: data.colors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    });

// Gr√°fico de Cidades
fetch('/api/charts/cidades')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('cidadesChart');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Lojas por Cidade',
                    data: data.data,
                    backgroundColor: '#667eea',
                    borderColor: '#764ba2',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
